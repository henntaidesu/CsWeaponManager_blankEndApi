# YYYP武器ClassID模块完成说明

## 📋 任务完成清单

### ✅ 1. 数据库模型创建
**文件**: `blankEndApi/src/db_manager/yyyp/yyyp_weapon_classID.py`

**包含功能**:
- ✅ 基础数据模型 `YyypWeaponClassIDModel`
- ✅ 7个数据字段: `Id`, `CommodityName`, `weapon_type`, `weapon_name`, `item_name`, `OnSaleCount`, `OnLeaseCount`
- ✅ 2个时间戳字段: `created_at`, `updated_at`
- ✅ 3个索引优化: `weapon_type`, `weapon_name`, `item_name`
- ✅ 5个自定义查询方法:
  - `find_by_weapon_info()` - 根据武器信息查询
  - `find_by_commodity_name()` - 根据商品名称查询
  - `get_available_weapons()` - 获取可用武器
  - `batch_insert_or_update()` - 批量插入或更新

### ✅ 2. 后端API接口创建
**文件**: `blankEndApi/src/web_side/youpin898/select_weapon/select_weapon_v1.py`

**包含10个API接口**:
1. ✅ `GET /getWeaponList` - 获取所有武器列表
2. ✅ `GET /getWeaponById/<weapon_id>` - 根据ID获取武器
3. ✅ `GET /getWeaponByType/<weapon_type>` - 根据类型获取武器
4. ✅ `POST /searchWeapon` - 多条件搜索武器
5. ✅ `GET /getAvailableWeapons` - 获取可用武器
6. ✅ `POST /batchInsertOrUpdate` - 批量插入或更新
7. ✅ `POST /insertWeapon` - 插入单个武器
8. ✅ `PUT /updateWeapon/<weapon_id>` - 更新武器数据
9. ✅ `DELETE /deleteWeapon/<weapon_id>` - 删除武器
10. ✅ `GET /getWeaponCount` - 获取武器总数

### ✅ 3. 模块注册
- ✅ 已在 `blankEndApi/src/db_manager/yyyp/__init__.py` 中导出模型
- ✅ 已在 `blankEndApi/src/db_manager/manager.py` 中注册模型到数据库管理器
- ✅ 已在 `blankEndApi/blankEndApi.py` 中注册API Blueprint

### ✅ 4. 文档和测试
- ✅ API接口文档: `README.md`
- ✅ 测试脚本: `blankEndApi/test_weapon_classid.py`
- ✅ 完成说明: `完成说明.md`

---

## 🗂️ 文件结构

```
blankEndApi/
├── src/
│   ├── db_manager/
│   │   ├── yyyp/
│   │   │   ├── __init__.py (已更新 - 导出YyypWeaponClassIDModel)
│   │   │   └── yyyp_weapon_classID.py (新建 - 数据模型)
│   │   └── manager.py (已更新 - 注册新模型)
│   └── web_side/
│       └── youpin898/
│           └── select_weapon/
│               ├── select_weapon_v1.py (新建 - API接口)
│               ├── README.md (新建 - API文档)
│               └── 完成说明.md (本文件)
├── blankEndApi.py (已更新 - 注册Blueprint)
└── test_weapon_classid.py (新建 - 测试脚本)
```

---

## 📊 数据表结构

**表名**: `yyyp_weapon_classID`

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| Id | INTEGER | PRIMARY KEY | 武器模板ID |
| CommodityName | TEXT | NULL | 完整商品名称 |
| weapon_type | TEXT | NULL, INDEX | 武器类型 |
| weapon_name | TEXT | NULL, INDEX | 武器名称 |
| item_name | TEXT | NULL, INDEX | 皮肤名称 |
| OnSaleCount | INTEGER | NULL | 在售数量 |
| OnLeaseCount | INTEGER | NULL | 租赁数量 |
| created_at | DATETIME | DEFAULT NOW | 创建时间 |
| updated_at | DATETIME | DEFAULT NOW | 更新时间 |

**索引**:
- `idx_weapon_type` on `weapon_type`
- `idx_weapon_name` on `weapon_name`
- `idx_item_name` on `item_name`

---

## 🚀 如何使用

### 1. 启动后端服务
```bash
cd blankEndApi
python blankEndApi.py
```

服务将在 `http://localhost:9001` 启动

### 2. 测试表创建
```bash
cd blankEndApi
python test_weapon_classid.py
```

### 3. 访问API接口
API基础URL: `http://localhost:9001/youpin898SelectWeaponV1`

示例:
- 获取所有武器: `GET http://localhost:9001/youpin898SelectWeaponV1/getWeaponList`
- 根据类型查询: `GET http://localhost:9001/youpin898SelectWeaponV1/getWeaponByType/匕首`

### 4. 在爬虫中使用

在 `Spider/src/web_site/youping/select_weapon/select_templateId.py` 中:

```python
import requests

# 获取所有武器数据
selector = selectTemplateId(config)
all_weapons = selector.getAllTemplateIds(['CSGO_Type_Knife_Unlimited'])

# 发送到后端API
api_url = "http://localhost:9001/youpin898SelectWeaponV1/batchInsertOrUpdate"
response = requests.post(api_url, json=all_weapons)

if response.status_code == 200:
    result = response.json()
    print(f"成功插入 {result['success_count']} 条数据")
```

---

## 🔗 与爬虫模块的集成

爬虫模块已完成字段解析:
- ✅ `Spider/src/web_site/youping/select_weapon/select_templateId.py`
- ✅ `parseJSON()` 函数会调用 `parse_cs2_name()` 解析武器名称
- ✅ 提取字段: `Id`, `CommodityName`, `weapon_type`, `weapon_name`, `item_name`, `OnSaleCount`, `OnLeaseCount`

数据流:
```
悠悠有品API 
  → Spider解析 (parseJSON + parse_cs2_name)
  → 提取7个字段
  → 发送到后端API
  → 存入 yyyp_weapon_classID 表
```

---

## 📝 后续建议

### 1. 定时同步任务
可以创建定时任务，定期从悠悠有品获取最新武器数据并更新数据库:

```python
import schedule
import time

def sync_weapons():
    selector = selectTemplateId(config)
    all_weapons = selector.getAllTemplateIds(weapon_type_list)
    
    # 发送到API
    response = requests.post(api_url, json=all_weapons)
    print(f"同步完成: {response.json()}")

# 每小时执行一次
schedule.every(1).hours.do(sync_weapons)

while True:
    schedule.run_pending()
    time.sleep(60)
```

### 2. 数据统计
可以添加更多统计功能，如:
- 各类型武器数量统计
- 价格区间分布
- 热门武器排行

### 3. 前端展示
可以在 `WebSite` 前端项目中添加武器浏览页面:
- 武器列表展示
- 筛选和搜索
- 详情查看

---

## ✅ 验证清单

启动后端服务后，数据库会自动初始化。你可以检查:

1. ✅ 数据库中是否存在 `yyyp_weapon_classID` 表
2. ✅ 表结构是否包含所有9个字段
3. ✅ 是否创建了3个索引
4. ✅ API接口是否可以正常访问
5. ✅ 测试脚本是否全部通过

---

## 🎉 完成

所有功能已按要求完成:
- ✅ 后端目录创建: `blankEndApi/src/web_side/youpin898/select_weapon`
- ✅ 数据表模型: `yyyp_weapon_classID`
- ✅ 字段匹配: 与爬虫解析的7个字段完全一致
- ✅ API接口: 10个RESTful接口
- ✅ 自动初始化: 启动时自动创建表
- ✅ 完整文档: API文档和使用说明

现在可以启动后端服务，表会自动创建！

